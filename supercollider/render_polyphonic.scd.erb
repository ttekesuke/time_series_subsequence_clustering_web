var server = Server(\nrt,
    options: ServerOptions.new
    .numOutputBusChannels_(2)
    .numInputBusChannels_(2)
    .sampleRate_(44100)
);

a = Score([
  [0.0, ['/d_recv',
    SynthDef(\polySynth, {
        |out=0, freq=440, dur=0.25, amp=0.5,
         brightness=0.5, hardness=0.5, texture=0.0, resonance=0.2|

        var sig, env, core, sub;
        var attackTime, releaseTime, cutoff, rq, feedback, pulseWidth, noiseSig;

        attackTime = (1.0 - hardness).linexp(0.0, 1.0, 0.001, 0.2).min(dur * 0.5);
        releaseTime = dur * (1.0 + (resonance * 2.0));
        env = EnvGen.ar(Env.perc(attackTime, releaseTime, 1.0, -4), doneAction: 2);

        feedback = texture.linlin(0.0, 1.0, 0.0, 2.5);
        core = SinOscFB.ar(freq, feedback);

        pulseWidth = 0.5 + (texture * 0.4);
        core = core * (1.0 - (texture * 0.5)) + (Pulse.ar(freq, pulseWidth) * (texture * 0.5));

        noiseSig = PinkNoise.ar() * (texture - 0.7).max(0) * 0.5;
        sub = SinOsc.ar(freq) * (1.0 - texture).max(0.2) * 0.5;
        sig = core + noiseSig + sub;

        cutoff = freq * (1 + (brightness * 20));
        cutoff = cutoff.clip(20, 20000);

        rq = (1.0 - (resonance * 0.95)).clip(0.02, 1.0);

        sig = RLPF.ar(sig, cutoff, rq);
        sig = BHiShelf.ar(sig, 3000, 1.0, (brightness - 0.5) * 12);

        sig = sig * env * amp;
        sig = sig.tanh;

        Out.ar(out, sig ! 2);
    }).asBytes;
  ]],

  <%
    current_time = 0.0
    node_id = 1000

    # time_series: [step][stream] = [oct, notePCS(Array or scalar), vol, bri, hrd, tex]
    time_series.each do |step_streams|
  %>
    <% (step_streams || []).each do |s| %>
      <%
         oct  = s[0].to_i
         note_val = s[1]
         pcs = note_val.is_a?(Array) ? note_val : [note_val]
         pcs = pcs.compact.map { |x| x.to_i % 12 }
         pcs = [0] if pcs.empty?

         vol  = s[2].to_f
         bri  = s[3].to_f
         hrd  = s[4].to_f
         tex  = s[5].to_f

         base_c_midi = (oct + 1) * 12
         amp_each = (pcs.length > 0) ? (vol.to_f / pcs.length.to_f) : vol.to_f
         amp_each *= 0.5

         if vol > 0.01
           pcs.each do |pc|
             midi_note = base_c_midi + pc.to_i
             freq = midi_to_freq.call(midi_note)
      %>
        [<%= current_time %>, ['/s_new', \polySynth, <%= node_id %>, 0, 0,
          \freq, <%= freq %>,
          \dur, <%= step_duration %>,
          \amp, <%= amp_each %>,
          \brightness, <%= bri %>,
          \hardness, <%= hrd %>,
          \texture, <%= tex %>,
          \resonance, 0.2
        ]],
      <%
             node_id += 1
           end
         end
      %>
    <% end %>
    <% current_time += step_duration %>
  <% end %>
]);

a.recordNRT(
    outputFilePath: <%= filepath.to_s.dump %>,
    headerFormat: "wav",
    sampleFormat: "int16",
    options: server.options,
    duration: <%= total_duration + 2.0 %>,
    action: { "done".postln }
);

server.remove;
