services:
  api:
    working_dir: /app
    build:
      context: .
    ports:
      - "${PORT:-9111}:${PORT:-9111}"
    environment:
      GENIE_ENV: dev
      HOST: "${HOST:-0.0.0.0}"
      PORT: "${PORT:-9111}"
    volumes:
      - ./:/app
      - julia_depot_1_12_4:/julia_depot
    user: "${UID}:${GID}"
    command: ["bash","-lc","julia --project=/app -e 'using Pkg; Pkg.instantiate()' && PORT=${PORT:-9111} HOST=${HOST:-0.0.0.0} bin/server"]

  web:
    image: node:20-bookworm-slim
    working_dir: /app
    depends_on:
      - api
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - node_modules:/app/node_modules
    environment:
      CHOKIDAR_USEPOLLING: "true"
      VITE_API_TARGET: "http://api:${PORT:-9111}"
    user: "${UID}:${GID}"
    command: ["bash","-lc","npm run dev -- --host 0.0.0.0 --port 5173"]

volumes:
  node_modules:
  julia_depot_1_12_4:
