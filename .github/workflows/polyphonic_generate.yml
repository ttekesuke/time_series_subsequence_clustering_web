name: Polyphonic Generate (Artifacts)
run-name: polyphonic-${{ inputs.request_id || github.run_id }}

on:
  workflow_dispatch:
    inputs:
      request_id:
        description: "Client request/job id (optional, for traceability)"
        required: false
        type: string
      params_b64:
        description: "Base64-encoded JSON payload for /api/web/time_series/generate_polyphonic"
        required: true
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      GENIE_ENV: prod
      GENIE_HOST: 127.0.0.1
      GENIE_PORT: "9111"
      PORT: "9111"
      JULIA_NUM_THREADS: "auto"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1.11.6"

      - name: Julia cache
        uses: julia-actions/cache@v2

      - name: Instantiate & precompile
        run: |
          set -eux
          julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.precompile()'

      - name: Install SuperCollider
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y supercollider

      - name: Decode params
        shell: bash
        run: |
          set -euo pipefail
          printf '%s' '${{ inputs.params_b64 }}' | base64 -d > params.json
          echo "params.json written: $(wc -c < params.json) bytes"

      - name: Start API server
        shell: bash
        run: |
          set -euxo pipefail

          julia --project=. scripts/start_server.jl > server.log 2>&1 &
          echo $! > server.pid

          for i in $(seq 1 600); do
            if ! kill -0 "$(cat server.pid)" 2>/dev/null; then
              echo "Server process exited early"
              echo "==== server.log (tail) ===="
              tail -n 300 server.log || true
              exit 1
            fi

            code="$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:${GENIE_PORT}/api/health || true)"
            if [ "$code" = "200" ]; then
              echo "Server is ready (HTTP 200)"
              break
            fi

            if (( i % 10 == 0 )); then
              echo "waiting... ${i}s (last HTTP: ${code})"
              tail -n 50 server.log || true
              echo "----"
            fi

            sleep 1
          done

          code="$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:${GENIE_PORT}/api/health || true)"
          if [ "$code" != "200" ]; then
            echo "Server did not become ready in time (last HTTP: ${code})"
            echo "==== ss -ltnp ===="
            ss -ltnp || true
            echo "==== server.log (tail) ===="
            tail -n 300 server.log || true
            exit 1
          fi

      - name: Generate polyphonic result.json
        shell: bash
        run: |
          set -euxo pipefail
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            --data-binary @params.json \
            http://127.0.0.1:${GENIE_PORT}/api/web/time_series/generate_polyphonic \
            > result.json
          python3 - <<'PY'
          import json
          obj=json.load(open('result.json','r',encoding='utf-8'))
          assert 'timeSeries' in obj, 'missing timeSeries in response'
          print('timeSeries length:', len(obj['timeSeries']))
          PY

      - name: Render wav (decode audio_data)
        shell: bash
        run: |
          set -euxo pipefail
          python3 - <<'PY'
          import json, base64, urllib.request
          result = json.load(open('result.json','r',encoding='utf-8'))
          req = {
            'render_polyphonic': {
              'time_series': result['timeSeries'],
              'note_chords_pitch_classes': result.get('noteChordsPitchClasses', []),
              'step_duration': 0.25,
            }
          }
          data = json.dumps(req).encode('utf-8')
          http_req = urllib.request.Request(
            'http://127.0.0.1:9111/api/web/supercolliders/render_polyphonic',
            data=data,
            headers={'Content-Type':'application/json'},
            method='POST',
          )
          with urllib.request.urlopen(http_req, timeout=3600) as r:
            body = r.read()
          resp = json.loads(body.decode('utf-8'))
          audio_b64 = resp.get('audio_data','')
          if ',' in audio_b64:
            audio_b64 = audio_b64.split(',',1)[1]
          wav = base64.b64decode(audio_b64.encode('utf-8'))
          open('result.wav','wb').write(wav)
          print('result.wav written:', len(wav), 'bytes')
          PY

      - name: Stop server
        if: always()
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f server.pid ]; then
            kill "$(cat server.pid)" || true
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: polyphonic-${{ inputs.request_id || github.run_id }}
          path: |
            params.json
            result.json
            result.wav
            server.log
