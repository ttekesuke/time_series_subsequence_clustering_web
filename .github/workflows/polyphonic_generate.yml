name: Polyphonic Generate (Artifacts)
run-name: polyphonic-${{ inputs.request_id || github.run_id }}

on:
  workflow_dispatch:
    inputs:
      request_id:
        description: "Client request/job id (optional, for traceability)"
        required: false
        type: string
      params_b64:
        description: "Base64-encoded JSON payload for /api/web/time_series/generate_polyphonic"
        required: true
        type: string

permissions:
  contents: read
  actions: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      # Genie / bootstrap.jl が読む想定に寄せる
      GENIE_ENV: prod
      HOST: 127.0.0.1
      PORT: "9111"

      # precompile の再利用性を上げたい場合（compiled キャッシュが効きにくい時の保険）
      JULIA_CPU_TARGET: generic

    steps:
      - uses: actions/checkout@v4

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1.11.6"

      # ★ Julia depot をキャッシュ（packages / artifacts / compiled 等）
      - name: Cache Julia depot
        id: julia-cache
        uses: julia-actions/cache@v2
        with:
          cache-name: julia-${{ github.workflow }}-${{ github.job }}

      - name: Instantiate
        run: |
          julia --project=. -e 'using Pkg; Pkg.instantiate()'

      # ★ 初回（キャッシュミス）だけ precompile
      - name: Precompile (cache miss only)
        if: steps.julia-cache.outputs.cache-hit != 'true'
        run: |
          julia --project=. -e 'using Pkg; Pkg.precompile()'

      - name: Install SuperCollider
        run: |
          sudo apt-get update
          sudo apt-get install -y supercollider

      - name: Decode params
        shell: bash
        run: |
          set -euo pipefail
          printf '%s' '${{ inputs.params_b64 }}' | base64 -d > params.json

      - name: Start API Server
        shell: bash
        run: |
          set -euxo pipefail

          # 起動（ログを actions にも流す）
          julia --project=. bootstrap.jl > >(tee server.log) 2>&1 &
          echo $! > server.pid

          # ready待ち（120秒）
          for i in {1..120}; do
            if ! kill -0 "$(cat server.pid)" 2>/dev/null; then
              echo "Server process exited early"
              echo "==== server.log (tail) ===="
              tail -n 200 server.log || true
              exit 1
            fi

            code="$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:${PORT}/ || true)"
            if [ "$code" != "000" ]; then
              echo "Server is responding (HTTP $code)"
              break
            fi

            # 10秒ごとに状況だけ出す（ノイズ最小）
            if (( i % 10 == 0 )); then
              echo "waiting... ${i}s"
            fi

            sleep 1
          done

          code="$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:${PORT}/ || true)"
          if [ "$code" = "000" ]; then
            echo "Server did not become ready in time"
            echo "==== server.log (tail) ===="
            tail -n 200 server.log || true
            exit 1
          fi

      - name: Generate polyphonic result.json
        shell: bash
        run: |
          set -euxo pipefail
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            --data-binary @params.json \
            "http://127.0.0.1:${PORT}/api/web/time_series/generate_polyphonic" \
            > result.json

          python3 - <<'PY'
          import json
          obj=json.load(open("result.json","r",encoding="utf-8"))
          assert "timeSeries" in obj, "missing timeSeries in response"
          print("timeSeries length:", len(obj["timeSeries"]))
          PY

      - name: Render wav (decode audio_data)
        env:
          PORT: ${{ env.PORT }}
        run: |
          python3 - <<'PY'
          import json, base64, urllib.request, os

          port = os.environ.get("PORT","9111")
          result = json.load(open("result.json","r",encoding="utf-8"))
          req = {
            "render_polyphonic": {
              "time_series": result["timeSeries"],
              "note_chords_pitch_classes": result.get("noteChordsPitchClasses", []),
              "step_duration": 0.25
            }
          }
          data = json.dumps(req).encode("utf-8")
          http_req = urllib.request.Request(
            f"http://127.0.0.1:{port}/api/web/supercolliders/render_polyphonic",
            data=data,
            headers={"Content-Type": "application/json"},
            method="POST",
          )
          with urllib.request.urlopen(http_req, timeout=3600) as r:
            body = r.read()
          resp = json.loads(body.decode("utf-8"))
          audio_b64 = resp.get("audio_data","")
          if "," in audio_b64:
            audio_b64 = audio_b64.split(",",1)[1]
          wav = base64.b64decode(audio_b64.encode("utf-8"))
          open("result.wav","wb").write(wav)
          print("result.wav written:", len(wav), "bytes")
          PY

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: polyphonic-${{ inputs.request_id || github.run_id }}
          path: |
            result.json
            result.wav
            server.log
