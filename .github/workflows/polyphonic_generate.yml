name: Polyphonic Generate (Artifacts)
run-name: polyphonic-${{ inputs.request_id || github.run_id }}

on:
  workflow_dispatch:
    inputs:
      request_id:
        description: "Client request/job id (optional, for traceability)"
        required: false
        type: string
      params_b64:
        description: "Base64-encoded JSON payload for /api/web/time_series/generate_polyphonic"
        required: true
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      GENIE_ENV: dev
      GENIE_HOST: 127.0.0.1
      GENIE_PORT: "9111"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1.11.6"

      - name: Instantiate & precompile
        run: |
          julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.precompile()'

      - name: Install SuperCollider
        run: |
          sudo apt-get update
          sudo apt-get install -y supercollider

      - name: Decode params
        run: |
          python3 - <<'PY'
          import base64, os, sys
          b64 = os.environ["INPUT_PARAMS_B64"]
          raw = base64.b64decode(b64.encode("utf-8"))
          open("params.json", "wb").write(raw)
          print("params.json written:", len(raw), "bytes")
          PY

      - name: Start API server
        run: |
          julia --project=. bootstrap.jl > server.log 2>&1 &
          echo $! > server.pid
          python3 - <<'PY'
          import time, urllib.request
          url = "http://127.0.0.1:9111/api/web/health_check"
          for i in range(60):
            try:
              with urllib.request.urlopen(url, timeout=2) as r:
                if r.status == 200:
                  print("Server is up")
                  break
            except Exception:
              pass
            time.sleep(1)
          else:
            raise SystemExit("Server did not become ready")
          PY

      - name: Generate polyphonic result.json
        run: |
          curl -sS -X POST             -H "Content-Type: application/json"             --data-binary @params.json             http://127.0.0.1:9111/api/web/time_series/generate_polyphonic             > result.json
          python3 - <<'PY'
          import json
          obj=json.load(open("result.json","r",encoding="utf-8"))
          assert "timeSeries" in obj, "missing timeSeries in response"
          print("timeSeries length:", len(obj["timeSeries"]))
          PY

      - name: Render wav (decode audio_data)
        run: |
          python3 - <<'PY'
          import json, base64, urllib.request
          result = json.load(open("result.json","r",encoding="utf-8"))
          req = {
            "render_polyphonic": {
              "time_series": result["timeSeries"],
              "note_chords_pitch_classes": result.get("noteChordsPitchClasses", []),
              "step_duration": 0.25
            }
          }
          data = json.dumps(req).encode("utf-8")
          http_req = urllib.request.Request(
            "http://127.0.0.1:9111/api/web/supercolliders/render_polyphonic",
            data=data,
            headers={"Content-Type": "application/json"},
            method="POST",
          )
          with urllib.request.urlopen(http_req, timeout=3600) as r:
            body = r.read()
          resp = json.loads(body.decode("utf-8"))
          audio_b64 = resp.get("audio_data","")
          if "," in audio_b64:
            audio_b64 = audio_b64.split(",",1)[1]
          wav = base64.b64decode(audio_b64.encode("utf-8"))
          open("result.wav","wb").write(wav)
          print("result.wav written:", len(wav), "bytes")
          PY

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: polyphonic-${{ inputs.request_id || github.run_id }}
          path: |
            result.json
            result.wav
            server.log
